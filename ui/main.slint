import { Button, VerticalBox, HorizontalBox, LineEdit, ScrollView, ListView, ComboBox } from "std-widgets.slint";

// --- 1. DATOV√â STRUKTURY ---
export struct PartnerData {
    id: string,
    nazev: string,
    slozka: string,
    aktualizovano: string,
    ma_slozku: bool,
}

// --- 2. POMOCN√â KOMPONENTY ---
component MenuButton inherits Rectangle {
    in-out property<string> text;
    in-out property<bool> active;
    callback clicked;
    height: 45px;
    background: active ? #2CC985 : touch.has-hover ? #3d3d3d : #2e2e2e;
    border-radius: 6px;
    border-width: 1px;
    border-color: active ? #2CC985 : #3f3f3f;
    touch := TouchArea { clicked => { root.clicked(); } }
    HorizontalLayout {
        padding-left: 20px;
        Text {
            text: root.text; color: root.active ? #1A1A1A : white;
            vertical-alignment: center; font-size: 14px; font-weight: root.active ? 800 : 500;
        }
    }
}

// --- 3. OKNO PROGRESS BARU ---
export component ProgressWindow inherits Window {
    in-out property <float> progress: 0.0;
    in-out property <string> status: "P≈ôipravuji...";
    title: "Import Dat";
    width: 400px; height: 180px;
    background: #212121;
    always-on-top: true;
    VerticalLayout {
        padding: 30px; spacing: 20px; alignment: center;
        Text { text: root.status; color: white; font-size: 18px; font-weight: 700; horizontal-alignment: center; }
        Rectangle {
            width: 300px; height: 12px; background: #333; border-radius: 6px;
            Rectangle {
                width: root.progress * 300px; height: 12px; background: #2CC985; border-radius: 6px; x: 0;
                animate width { duration: 100ms; }
            }
        }
        Text { text: round(root.progress * 100) + "%"; color: #888; horizontal-alignment: center; }
    }
}

// --- 4. HLAVN√ç OKNO APLIKACE ---
export component AppWindow inherits Window {
    in-out property <string> verze_aplikace: "0.3.3";
    in-out property <string> cesta_archiv: "";
    in-out property <string> cesta_vyroba: "";
    in-out property <string> sync_interval: "1 t√Ωden";
    in-out property <string> posledni_sync_cas: "Nikdy";
    
    // Stavov√© k√≥dy: 0=OK, 1=Chyba, 2=Neaktu√°ln√≠
    in-out property <int> db_status_code: 1; 
    in-out property <string> stav_text: "DATAB√ÅZE NEN√ç NAƒåTENA";
    
    in-out property <[PartnerData]> model_partneru: [];
    in-out property <int> pocet_chybi: 0;

    property <int> vybrana_stranka: 0; 
    property <int> settings_tab: 0; // Defaultn√≠ z√°lo≈æka v nastaven√≠

    callback vybrat_archiv();
    callback vybrat_vyrobu();
    callback ulozit_nastaveni();
    callback spustit_synchronizaci();

    title: "MRB Obchodn√≠k - v" + verze_aplikace;
    min-width: 1000px; min-height: 700px;
    background: #1A1A1A;

    HorizontalLayout {
        padding: 0; spacing: 0;

        // LEV√ù PANEL
        Rectangle {
            width: 280px; background: #212121;
            VerticalLayout {
                padding: 25px; spacing: 10px;
                Text { text: "MRB Obchodn√≠k"; color: #2CC985; font-size: 20px; font-weight: 900; horizontal-alignment: center; }
                Rectangle { height: 20px; }
                MenuButton { text: "üè†   Domovsk√° obrazovka"; active: vybrana_stranka == 0; clicked => { vybrana_stranka = 0; } }
                MenuButton { text: "üìÇ   Nov√Ω import"; active: vybrana_stranka == 1; clicked => { vybrana_stranka = 1; } }
                MenuButton { 
                    text: "‚öô   Nastaven√≠ syst√©mu"; 
                    active: vybrana_stranka == 2; 
                    clicked => { 
                        vybrana_stranka = 2; 
                        settings_tab = 0; // V≈ædy nastav√≠ prvn√≠ z√°lo≈æku (Aktualizace dat)
                    } 
                }
                Rectangle { vertical-stretch: 1; }
                Text { text: "v" + root.verze_aplikace; color: #555; font-size: 11px; horizontal-alignment: center; }
            }
        }

        // PRAV√ù OBSAH
        VerticalLayout {
            padding: 40px; spacing: 20px;
            horizontal-stretch: 1;

            // 1. HORN√ç P≈òEP√çNAƒåE (V NASTAVEN√ç)
            if (vybrana_stranka == 2) : HorizontalLayout {
                height: 45px; spacing: 10px;
                vertical-stretch: 0;
                // Nov√© po≈ôad√≠ a n√°zvy
                Button { text: "Aktualizace dat"; primary: settings_tab == 0; clicked => { settings_tab = 0; } }
                Button { text: "Datab√°ze partner≈Ø"; primary: settings_tab == 1; clicked => { settings_tab = 1; } }
                Button { text: "Obecn√©"; primary: settings_tab == 2; clicked => { settings_tab = 2; } }
            }

            // 2. HLAVN√ç PLOCHA
            VerticalLayout {
                vertical-stretch: 1;

                if (vybrana_stranka == 0) : VerticalBox {
                    alignment: center; spacing: 20px;
                    Text { text: "üè†"; font-size: 80px; horizontal-alignment: center; }
                    Text { text: "V√≠tejte v syst√©mu MRB Obchodn√≠k"; font-size: 28px; font-weight: 800; color: white; horizontal-alignment: center; }
                }

                if (vybrana_stranka == 1) : VerticalBox {
                    alignment: center;
                    Text { text: "üìÇ"; font-size: 80px; horizontal-alignment: center; }
                    Text { text: "Sekce Import"; font-size: 24px; color: white; horizontal-alignment: center; }
                }

                if (vybrana_stranka == 2) : VerticalLayout {
                    vertical-stretch: 1;
                    
                    // TAB 0: AKTUALIZACE DAT (P≈ÆVODNƒö TAB 1)
                    if (settings_tab == 0) : VerticalLayout {
                        spacing: 25px; alignment: center;
                        Text { text: "Nahr√°n√≠ dat z Excelu"; font-size: 22px; font-weight: 700; color: white; horizontal-alignment: center; }
                        
                        Rectangle {
                            border-color: root.db_status_code == 0 ? #2CC985 : (root.db_status_code == 2 ? #f39c12 : #e74c3c); 
                            border-width: 2px; border-radius: 12px; height: 120px;
                            background: root.db_status_code == 0 ? #2CC98511 : (root.db_status_code == 2 ? #f39c1211 : #e74c3c11);
                            
                            Text { 
                                text: root.stav_text; 
                                color: root.db_status_code == 0 ? #2CC985 : (root.db_status_code == 2 ? #f39c12 : #e74c3c); 
                                font-size: 20px; font-weight: 800; horizontal-alignment: center; vertical-alignment: center; 
                            }
                        }
                        
                        Text { text: "Posledn√≠ √∫spƒõ≈°n√° aktualizace: " + root.posledni_sync_cas; color: #888; horizontal-alignment: center; }
                        Rectangle { vertical-stretch: 1; }
                        Button { text: "NAHR√ÅT EXCEL S PARTNERY"; height: 60px; primary: true; clicked => { root.spustit_synchronizaci(); } }
                    }

                    // TAB 1: DATAB√ÅZE PARTNER≈Æ (P≈ÆVODNƒö TAB 2)
                    if (settings_tab == 1) : VerticalLayout {
                        vertical-stretch: 1;
                        spacing: 15px;

                        HorizontalLayout {
                            height: 60px; spacing: 15px; vertical-stretch: 0;
                            Rectangle {
                                background: #252525; border-radius: 8px; width: 180px;
                                HorizontalLayout {
                                    padding: 10px; spacing: 15px;
                                    Text { text: "üë•"; vertical-alignment: center; font-size: 20px; }
                                    VerticalLayout {
                                        alignment: center;
                                        Text { text: "Celkem"; color: #888; font-size: 10px; }
                                        Text { text: root.model-partneru.length; color: white; font-weight: 700; }
                                    }
                                }
                            }
                            Rectangle {
                                background: #252525; border-radius: 8px; width: 180px;
                                HorizontalLayout {
                                    padding: 10px; spacing: 15px;
                                    Text { text: "üìÅ"; vertical-alignment: center; font-size: 20px; }
                                    VerticalLayout {
                                        alignment: center;
                                        Text { text: "Chyb√≠ slo≈æka"; color: #888; font-size: 10px; }
                                        Text { text: root.pocet_chybi; color: #e74c3c; font-weight: 700; }
                                    }
                                }
                            }
                            Rectangle {
                                background: #2e2e2e; border-radius: 8px; horizontal-stretch: 1;
                                HorizontalLayout { 
                                    padding-left: 15px; padding-right: 15px;
                                    Text { text: "üîç"; vertical-alignment: center; } 
                                    LineEdit { placeholder-text: "Hledat partnera..."; font-size: 14px; } 
                                }
                            }
                        }

                        Rectangle {
                            height: 40px; background: #2a2a2a; border-radius: 6px; vertical-stretch: 0;
                            HorizontalLayout {
                                padding-left: 20px; padding-right: 20px;
                                Text { text: "STAV"; width: 60px; color: #666; font-size: 11px; font-weight: 800; vertical-alignment: center; }
                                Text { text: "ID"; width: 100px; color: #666; font-size: 11px; font-weight: 800; vertical-alignment: center; }
                                Text { text: "N√ÅZEV"; width: 300px; color: #666; font-size: 11px; font-weight: 800; vertical-alignment: center; }
                                Text { text: "CESTA KE SLO≈ΩCE"; color: #666; font-size: 11px; font-weight: 800; vertical-alignment: center; }
                            }
                        }

                        ListView {
                            vertical-stretch: 1;
                            for partner in root.model_partneru : Rectangle {
                                height: 50px; background: #1e1e1e; border-radius: 6px;
                                HorizontalLayout {
                                    padding-left: 20px; padding-right: 20px;
                                    Rectangle { width: 60px; VerticalLayout { alignment: center; Rectangle { width: 10px; height: 10px; border-radius: 5px; background: partner.ma-slozku ? #2CC985 : #e74c3c; } } }
                                    Text { text: partner.id; width: 100px; color: #aaa; vertical-alignment: center; }
                                    Text { text: partner.nazev; width: 300px; color: white; font-weight: 600; vertical-alignment: center; overflow: elide; }
                                    Text { text: partner.slozka == "" ? "Nep≈ôi≈ôazeno" : partner.slozka; color: #555; font-size: 13px; vertical-alignment: center; overflow: elide; horizontal-stretch: 1; }
                                    Rectangle { width: 100px; VerticalLayout { alignment: center; Button { text: "Upravit"; height: 30px; } } }
                                }
                            }
                        }
                    }

                    // TAB 2: OBECN√â (P≈ÆVODNƒö TAB 0)
                    if (settings_tab == 2) : VerticalLayout {
                        spacing: 20px; alignment: start;
                        VerticalBox {
                            spacing: 5px; padding: 0;
                            Text { text: "CESTA K ARCHIVU ZAK√ÅZEK"; color: #888; font-size: 11px; font-weight: 700; }
                            HorizontalLayout {
                                spacing: 10px; height: 40px;
                                LineEdit { text: cesta_archiv; height: 40px; font-size: 14px; edited(t) => { root.cesta_archiv = t; } }
                                Button { text: "Zmƒõnit"; width: 100px; clicked => { root.vybrat_archiv(); } }
                            }
                        }
                        VerticalBox {
                            spacing: 5px; padding: 0;
                            Text { text: "CESTA PRO IMPORT DO V√ùROBY"; color: #888; font-size: 11px; font-weight: 700; }
                            HorizontalLayout {
                                spacing: 10px; height: 40px;
                                LineEdit { text: cesta_vyroba; height: 40px; font-size: 14px; edited(t) => { root.cesta_vyroba = t; } }
                                Button { text: "Zmƒõnit"; width: 100px; clicked => { root.vybrat_vyrobu(); } }
                            }
                        }
                        VerticalBox {
                            spacing: 5px; padding: 0;
                            Text { text: "INTERVAL KONTROLY AKTU√ÅLNOSTI DAT"; color: #888; font-size: 11px; font-weight: 700; }
                            ComboBox {
                                height: 40px;
                                model: ["1 t√Ωden", "14 dn√≠", "1 mƒõs√≠c", "6 mƒõs√≠c≈Ø", "teƒè..."];
                                current-value: root.sync_interval;
                                selected(val) => { 
                                    root.sync_interval = val; 
                                    root.ulozit_nastaveni(); 
                                }
                            }
                        }

                        Rectangle { vertical-stretch: 1; }
                        Button { text: "ULO≈ΩIT VE≈†KER√Å NASTAVEN√ç"; height: 50px; primary: true; clicked => { root.ulozit_nastaveni(); } }
                    }
                }
            }
        }
    }
}